# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é Job Queue

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

–¢–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**:
1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É (job) –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ü–æ–ª—É—á–∞–µ—Ç `jobId` –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
3. –û–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
4. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ (–¥–∞–∂–µ –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 2-3 –º–∏–Ω—É—Ç—ã)
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫–æ–Ω—Å–æ–ª–∏
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ

## –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å?

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
# –í Supabase SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
cat migrations/21_create_generation_jobs.sql
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
```bash
# –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω —Å Job Queue
# –õ–æ–≥: bot_v16_job_queue.log
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
1. –û—Ç–∫—Ä–æ–π—Ç–µ Lego —à–∞–±–ª–æ–Ω
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ
3. –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"
4. **–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)**
5. –í—ã —É–≤–∏–¥–∏—Ç–µ:
   ```
   üìã Job created: abc-123-def
   ‚è≥ Job abc-123-def status: processing
   ‚è≥ Job abc-123-def status: processing
   ‚è≥ Job abc-123-def status: completed
   ```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
SELECT id, status, created_at, completed_at, result_url 
FROM generation_jobs 
ORDER BY created_at DESC 
LIMIT 10;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
SELECT * FROM generation_jobs WHERE status = 'processing';
```

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –û—à–∏–±–∫–∞: "Table generation_jobs does not exist"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `21_create_generation_jobs.sql`

### –û—à–∏–±–∫–∞: "Permission denied for table generation_jobs"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞ –Ω–∞ "processing"
**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞: `cat bot_v16_job_queue.log`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DefAPI –∫–ª—é—á –≤ `.env`
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `MOCK_AI=false`

## –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Job Queue (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
```javascript
// –í TemplateView.jsx (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
const result = await aiService.generateImageAsync(...)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±):
```javascript
// –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é
const result = await aiService.generateImage(...)
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞:
```bash
tail -f bot_v16_job_queue.log
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–¥–∞—á:
```sql
SELECT 
    status, 
    COUNT(*) as count,
    AVG(EXTRACT(EPOCH FROM (completed_at - created_at))) as avg_duration_sec
FROM generation_jobs 
WHERE created_at > NOW() - INTERVAL '1 day'
GROUP BY status;
```

---
**–ì–æ—Ç–æ–≤–æ!** –°–∏—Å—Ç–µ–º–∞ Job Queue –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
