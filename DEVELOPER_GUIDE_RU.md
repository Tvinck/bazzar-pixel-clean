# Документация разработчика Pixel (Developer Guide)

## 1. Обзор проекта
**Pixel** — это Mini App в Telegram для генерации контента (изображения, видео, музыка) с использованием AI.
Проект состоит из:
1.  **Frontend**: React (Vite) приложение.
2.  **Backend/Database**: Supabase (PostgreSQL, Auth, Storage, Edge Functions).
3.  **Telegram Bot**: Node.js бот (`bot.js`), управляющий взаимодействием с пользователем и уведомлениями.

---

## 2. Структура проекта

### Основные директории
-   `/src` — Исходный код React приложения.
    -   `/views` — Основные экраны приложения.
        -   `HomeView.jsx` — Главная страница (шаблоны, баннеры).
        -   `GenerationView.jsx` — Экран генерации (форма настроек, выбор модели).
        -   `ProfileView.jsx` — Профиль пользователя, достижения, настройки.
        -   `GalleryView.jsx` — Лента публичных работ.
    -   `/components` — Переиспользуемые UI компоненты (кнопки, карточки, модалки).
    -   `/lib` — Библиотеки и утилиты.
        -   `supabase.js` — Клиент Supabase.
        -   `galleryAPI.js` — Функции для работы с БД (сохранение генераций, получение ленты).
        -   `ai-service.js` — Логика отправки запросов к AI провайдерам.
    -   `/context` — React Context (Global State).
        -   `UserContext.jsx` — Данные пользователя, баланс, функции оплаты.
-   `/public` — Статические файлы (картинки, видео-шаблоны).
-   `bot.js` — Основной файл Telegram бота.

---

## 3. Ключевые функции и логика

### Генерация (Generation Flow)
1.  Пользователь выбирает инструмент в `HomeView` или нажимает "+" -> попадает в `GenerationView`.
2.  В `GenerationView` выбирается модель (Flux, Kling, Suno и т.д.) и вводятся параметры.
3.  Кнопка "Сгенерировать":
    -   Вызывает `handleGenerate`.
    -   Проверяет баланс через `UserContext`.
    -   Отправляет запрос через `aiService`.
4.  `aiService` делает запрос к внешнему API (KIE, Replicate и др.).
5.  При успехе:
    -   Результат сохраняется в Supabase через `galleryAPI.saveCreation`.
    -   Кредиты списываются (транзакция в БД).
    -   Бот уведомляет пользователя (если это настроено).

### Оплата и Баланс
-   Баланс хранится в таблице `user_stats` (или `profiles`).
-   Логика списания: `src/context/UserContext.jsx` -> `pay()`.
-   Логика начисления: `addBalance()`.
-   История операций: таблица `transactions`.

### Шаблоны Видео
-   Хранятся в базе данных `templates` (или хардкодом в `src/data/templates.js` и синхронизируются).
-   Видео файлы лежат в `/public/videos`.
-   Для добавления нового шаблона:
    1.  Загрузить видео в `/public/videos`.
    2.  Добавить запись в БД или конфиг.
    3.  Убедиться, что есть превью (постер).

---

## 4. База данных (Supabase)

### Основные таблицы
-   `users`: Телеграм ID, имя, аватар.
-   `creations`: Все работы пользователей.
    -   `is_public`: Видимость в ленте (по умолчанию `false`).
    -   `image_url`: Ссылка на результат.
-   `transactions`: История списаний и пополнений.
-   `templates`: Доступные шаблоны для генерации.

---

## 5. Полезные команды

### Запуск локально
```bash
npm run dev
```
Запускает frontend на `localhost:5173`.

### Запуск бота
```bash
node bot.js
```

### Деплой
Проект настроен для деплоя на Vercel (Frontend) и VPS (Bot).

---

## 6. Yandex Market (Интеграция)
Скрипт `run_yandex_processing.js` (в соседней папке `bazzar-app` или корне) отвечает за:
-   Обработку заказов цифровых товаров.
-   Отправку кодов/ссылок покупателям.
-   Важно: Использует метод `deliverDigitalGoods` для смены статуса на `DELIVERED`.

---

## 7. Админка (Staff Panel)
Управление Pixel интегрировано в `bazzar-staff` -> страница `PixelPage`.
Возможности:
-   Просмотр пользователей и балансов.
-   Модерация генераций (удаление).
-   Просмотр статистики доходов/расходов кредитов.
-   Рассылка сообщений (Broadcast).
