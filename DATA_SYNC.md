# ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö - –ì–û–¢–û–í–û

## üéØ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `telegram_id` –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ UUID)
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –±–æ—Ç–æ–º –∏ –º–∏–Ω–∏-–∞–ø–ø–æ–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. **–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–µ–∑–¥–µ**

#### –í –±–æ—Ç–µ (`bot.js`):
```javascript
// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await botAnalytics.upsertUser(msg.from);
await botAnalytics.trackCommand(msg.from.id, 'start');
await botAnalytics.trackEvent(msg.from.id, 'button_click', { button: 'community' });
```

#### –í –º–∏–Ω–∏-–∞–ø–ø–µ (`App.jsx`):
```javascript
// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const user = tg.initDataUnsafe?.user;
await analytics.trackSession(user.id, user);
const stats = await analytics.getUserStats(user.id);
setBalance(stats.current_balance || 0);
```

#### –í –ø—Ä–æ—Ñ–∏–ª–µ (`ProfileView.jsx`):
```javascript
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
const displayName = userData?.first_name || 'User';
const username = userData?.username || 'pixel_user';
const totalCreations = userStats?.total_generations || 0;
const totalLikes = userStats?.total_likes_received || 0;
const userLevel = Math.floor((userStats?.total_generations || 0) / 10) + 1;
```

### 3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**

#### `src/lib/supabase.js`:
- ‚úÖ `trackSession(telegramId, telegramData)` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `upsertUser(telegramId, telegramData)` - —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `trackGeneration(telegramId, type, prompt, status)` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ `trackEvent(telegramId, eventName, eventData)` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
- ‚úÖ `getUserStats(telegramId)` - –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ telegram_id
- ‚úÖ `updateUserProfile(telegramId, profileData)` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å

#### `bot-supabase.js`:
- ‚úÖ `upsertUser(telegramUser)` - —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `trackCommand(telegramId, command, args)` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ `trackEvent(telegramId, eventName, eventData)` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
- ‚úÖ `getTotalUsers()` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `getActiveUsersToday()` - –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`:
```sql
telegram_id BIGINT UNIQUE NOT NULL  -- –û—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
username TEXT
first_name TEXT
last_name TEXT
language_code TEXT
is_premium BOOLEAN
level INTEGER DEFAULT 1
xp INTEGER DEFAULT 0
last_active_at TIMESTAMP
```

### –¢–∞–±–ª–∏—Ü–∞ `user_sessions`:
```sql
telegram_id BIGINT NOT NULL
username TEXT
first_name TEXT
session_start TIMESTAMP
session_end TIMESTAMP
```

### –¢–∞–±–ª–∏—Ü–∞ `events`:
```sql
user_id UUID (nullable)
event_name TEXT
event_data JSONB  -- —Å–æ–¥–µ—Ä–∂–∏—Ç telegram_id
created_at TIMESTAMP
```

### –¢–∞–±–ª–∏—Ü–∞ `user_stats`:
```sql
user_id UUID PRIMARY KEY
total_generations INTEGER
successful_generations INTEGER
total_likes_received INTEGER
current_balance INTEGER
```

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞:
```
Telegram ‚Üí bot.js ‚Üí botAnalytics.upsertUser() ‚Üí Supabase users
                  ‚Üí botAnalytics.trackCommand() ‚Üí Supabase events
```

### 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–Ω–∏-–∞–ø–ø:
```
Telegram WebApp ‚Üí App.jsx ‚Üí analytics.trackSession() ‚Üí Supabase user_sessions
                           ‚Üí analytics.getUserStats() ‚Üí Supabase user_stats
                           ‚Üí ProfileView.jsx ‚Üí –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
```

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É:
```
–ë–æ—Ç: msg.from.id ‚Üí botAnalytics.trackEvent() ‚Üí Supabase events
–ê–ø–ø: telegramUser.id ‚Üí analytics.trackEvent() ‚Üí Supabase events
```

---

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã**
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Supabase
- telegram_id - –µ–¥–∏–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### 2. **–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**
- –ò–º—è –∏ username –∏–∑ Telegram
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ë–∞–ª–∞–Ω—Å –∏–∑ user_stats
- –£—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

### 3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**
- –¢—Ä–∏–≥–≥–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç user_stats
- –ö–∞–∂–¥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏
- XP –∏ —É—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
- –ú–∏–Ω–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ state
- Fallback –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ ‚Üí `/start`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Supabase ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `users` ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞—à telegram_id
3. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–∞–ø–ø
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å ‚Üí –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–æ—Ç–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `events` ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `user_stats` ‚Üí —Å—á–µ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–∏—Ç—å—Å—è

---

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "User not found"
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞: "Stats is null"
**–†–µ—à–µ–Ω–∏–µ:** user_stats —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: "Balance is 0"
**–†–µ—à–µ–Ω–∏–µ:** –ù–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–æ–±–∞–≤—å—Ç–µ –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤ —Ç—Ä–∏–≥–≥–µ—Ä

---

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç–µ SQL —Å—Ö–µ–º—É –≤ Supabase
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–Ω–∏-–∞–ø–ø
4. üîÑ –î–æ–±–∞–≤—å—Ç–µ –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. üîÑ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É
6. üîÑ –î–æ–±–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

---

**–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª—å–Ω—ã–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!** üéâ
